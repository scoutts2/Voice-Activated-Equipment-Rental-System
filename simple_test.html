<!DOCTYPE html>
<html>
<head>
    <title>Test Equipment Rental Agent</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <script>
        // Check if LiveKit is loaded
        window.addEventListener('load', function() {
            if (typeof LiveKit === 'undefined') {
                document.getElementById('status').innerHTML = '‚ùå LiveKit library failed to load';
                console.error('LiveKit library not loaded');
            } else {
                console.log('LiveKit library loaded successfully');
            }
        });
    </script>
</head>
<body>
    <h1>üß™ Test Your Equipment Rental Agent</h1>
    
    <div id="status">Ready to connect...</div>
    <div id="messages"></div>
    
    <button onclick="connectToRoom()">Connect to Agent</button>
    
    <script>
        const room = new LiveKit.Room();
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        
        function addMessage(message, type = 'info') {
            const div = document.createElement('div');
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            div.style.color = type === 'error' ? 'red' : 'blue';
            div.style.margin = '5px 0';
            messagesDiv.appendChild(div);
        }
        
        // Room event handlers
        room.on(LiveKit.RoomEvent.Connected, () => {
            statusDiv.innerHTML = '‚úÖ Connected to room!';
            addMessage('Connected to room - waiting for agent...');
        });
        
        room.on(LiveKit.RoomEvent.ParticipantConnected, (participant) => {
            if (participant.identity.includes('agent')) {
                addMessage('ü§ñ Agent joined the room!');
                statusDiv.innerHTML = 'üéâ Agent is here! Start talking!';
            } else {
                addMessage(`üë§ ${participant.identity} joined the room`);
            }
        });
        
        room.on(LiveKit.RoomEvent.TrackSubscribed, (track, publication, participant) => {
            if (track.kind === 'audio' && participant.identity.includes('agent')) {
                addMessage('üé§ Agent audio is now available!');
                // Play the audio
                const audioElement = track.attach();
                audioElement.play();
            }
        });
        
        room.on(LiveKit.RoomEvent.Disconnected, () => {
            statusDiv.innerHTML = '‚ùå Disconnected';
            addMessage('Disconnected from room');
        });
        
        // Connect to room
        async function connectToRoom() {
            try {
                console.log('Connect button clicked');
                statusDiv.innerHTML = 'üîÑ Connecting...';
                addMessage('Connecting to room...');
                
                const roomName = 'rental-test-1759902029';
                addMessage(`Room: ${roomName}`);
                
                // Generate a simple token (this is a basic approach)
                const token = await generateToken(roomName);
                addMessage('Token generated');
                
                addMessage('Attempting to connect to LiveKit...');
                await room.connect('wss://construction-piq5yw2y.livekit.cloud', token);
                
            } catch (error) {
                console.error('Connection error:', error);
                addMessage(`Error: ${error.message}`, 'error');
                statusDiv.innerHTML = '‚ùå Connection failed';
            }
        }
        
        // Simple token generation (you'll need to replace this with real token)
        async function generateToken(roomName) {
            // Use the generated token
            const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJBUElYSkVpZUZFY0VWSEEiLCJzdWIiOiJ0ZXN0LXVzZXIiLCJleHAiOjE3NTk5MDU4MDcsInJvb20iOiJyZW50YWwtdGVzdC0xNzU5OTAyMDI5IiwidmlkZW8iOnsicm9vbSI6InJlbnRhbC10ZXN0LTE3NTk5MDIwMjkiLCJyb29tSm9pbiI6dHJ1ZSwiY2FuUHVibGlzaCI6dHJ1ZSwiY2FuU3Vic2NyaWJlIjp0cnVlfSwiYXVkaW8iOnsicm9vbSI6InJlbnRhbC10ZXN0LTE3NTk5MDIwMjkiLCJyb29tSm9pbiI6dHJ1ZSwiY2FuUHVibGlzaCI6dHJ1ZSwiY2FuU3Vic2NyaWJlIjp0cnVlfX0.iq8rm8q6nXkTKJh0Ukh1KQMcUv5oywxxKCuVY6pMPyQ";
            addMessage('‚úÖ Using generated JWT token');
            return token;
        }
    </script>
    
    <div style="margin-top: 20px; padding: 10px; background: #f0f0f0;">
        <h3>üìã Instructions:</h3>
        <ol>
            <li>Click "Connect to Agent" button</li>
            <li>Allow microphone access when prompted</li>
            <li>Wait for "Agent joined the room!" message</li>
            <li>Start talking to test your equipment rental agent!</li>
        </ol>
        
        <h3>üîß If Connection Fails:</h3>
        <p>We need to generate a proper JWT token. Let me create a token generator for you.</p>
    </div>
</body>
</html>
